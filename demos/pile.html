<!DOCTYPE html>
<html>
<head>
    <title>cannon.js - pile demo</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/style.css" type="text/css"/>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>
<body>
    <script src="../build/ammo.js"></script>
    <script src="../build/cannon.demo.js"></script>
    <script src="../libs/dat.gui.js"></script>
    <script src="../libs/Three.js"></script>
    <script src="../libs/TrackballControls.js"></script>
    <script src="../libs/Detector.js"></script>
    <script src="../libs/Stats.js"></script>
    <script src="../libs/smoothie.js"></script>
    <script>

    var demo = new CANNON.Demo();
    var size = 1;
    var interval;

    // Spheres
    demo.addScene("Pile",function(){
        if(interval) clearInterval(interval);

        var world = demo.getWorld();

        world.setGravity(new Ammo.btVector3(0,0,-50));
        //world.broadphase = new CANNON.NaiveBroadphase();
        //world.solver.iterations = 5;

        //world.defaultContactMaterial.contactEquationStiffness = 5e6;
        //world.defaultContactMaterial.contactEquationRelaxation = 10;
        // XXX bullet will still run its full-precision code path
        // Since we have many bodies and they don't move very much, we can use the less accurate quaternion normalization
        //world.quatNormalizeFast = true;
        //world.quatNormalizeSkip = 3; // ...and we do not have to normalize every step.

        // ground plane
        function makePlane(x, y, z, w) {
          var shape = new Ammo.btStaticPlaneShape(new Ammo.btVector3(x, y, z), w);
          var transform = new Ammo.btTransform();
          transform.setIdentity();
          transform.setOrigin(new Ammo.btVector3(0, 0, 0));
          var localInertia = new Ammo.btVector3(0, 0, 0);
          var myMotionState = new Ammo.btDefaultMotionState(transform);
          var rbInfo = new Ammo.btRigidBodyConstructionInfo(0, myMotionState, shape, localInertia);
          var body = new Ammo.btRigidBody(rbInfo);
          return body;
        }
        var groundBody = makePlane(0, 0, 1, 0);
        world.addRigidBody(groundBody);
        demo.addVisual(groundBody);

        // plane -x
        var planeXmin = makePlane(0, 1, 0, -5);
        world.addRigidBody(planeXmin);

        // Plane +x
        var planeXmax = makePlane(0, -1, 0, -5);
        world.addRigidBody(planeXmax);

        // Plane -y
        var planeYmin = makePlane(1, 0, 0, -5);
        world.addRigidBody(planeYmin);

        // Plane +y
        var planeYmax = makePlane(-1, 0, 0, -5);
        world.addRigidBody(planeYmax);

        var bodies = [];
        var i = 0;

        interval = setInterval(function(){
            // Sphere
            i++;
            var sphereShape = new Ammo.btSphereShape(size); // XXX ficm

            var startTransform = new Ammo.btTransform();
            startTransform.setIdentity();
            var localInertia = new Ammo.btVector3(0, 0, 0);
            var mass = 5;
            sphereShape.calculateLocalInertia(mass, localInertia);

            var myMotionState = new Ammo.btDefaultMotionState(startTransform);
            var rbInfo = new Ammo.btRigidBodyConstructionInfo(mass, myMotionState, sphereShape, localInertia);
            var b1 = new Ammo.btRigidBody(rbInfo);
            b1.shape = sphereShape;

            var origin = b1.getWorldTransform().getOrigin();
            origin.setX(2*size*Math.sin(i));
            origin.setY(2*size*Math.cos(i));
            origin.setZ(7*2*size);

            world.addRigidBody(b1);
            demo.addVisual(b1);
            bodies.push(b1);

            if(bodies.length>80){
                var b = bodies.shift();
                demo.removeVisual(b);
                world.removeRigidBody(b);
                Ammo.destroy(b); // XXX
            }
        },100);
    });

    demo.start();

    </script>
</body>
</html>
